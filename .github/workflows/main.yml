
name: Deploy and update Azure Container App testv2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if secrets are injected
        run: |
          if [ -z "${{ secrets.AZURE_CREDENTIALS }}" ]; then
            echo "AZURE_CREDENTIALS is NOT set"
            exit 1
          else
            echo "AZURE_CREDENTIALS is set"
          fi

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push image
        run: |
          set -euo pipefail
          IMAGE="${{ secrets.ACR_LOGIN_SERVER }}/${{ secrets.IMAGE_NAME }}:${{ github.sha }}"
          docker build -t "$IMAGE" ./server
          docker push "$IMAGE"
          # 将 IMAGE 注入后续步骤的 shell 环境
          echo "IMAGE=$IMAGE" >> "$GITHUB_ENV"

      - name: Replace variables in containerapp.yaml
        run: |
          set -euo pipefail
          YAML="${{ github.workspace }}/server/containerapp.yaml"
          sed -i "s|<ACR_LOGIN_SERVER>|${{ secrets.ACR_LOGIN_SERVER }}|g" "$YAML"
          sed -i "s|<ACR_USERNAME>|${{ secrets.ACR_USERNAME }}|g" "$YAML"
          sed -i "s|<ACR_PASSWORD>|${{ secrets.ACR_PASSWORD }}|g" "$YAML"
          sed -i "s|<IMAGE_NAME>|${{ secrets.IMAGE_NAME }}|g" "$YAML"
          sed -i "s|<TAG>|${{ github.sha }}|g" "$YAML"
          sed -i "s|<AZURE_OPENAI_ENDPOINT>|${{ secrets.AZURE_OPENAI_ENDPOINT }}|g" "$YAML"
          sed -i "s|<AZURE_OPENAI_API_KEY>|${{ secrets.AZURE_OPENAI_API_KEY }}|g" "$YAML"
          sed -i "s|<AZURE_OPENAI_CHAT_DEPLOYMENT_VERSION>|${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT_VERSION }}|g" "$YAML"
          sed -i "s|<AZURE_OPENAI_CHAT_DEPLOYMENT>|${{ secrets.AZURE_OPENAI_CHAT_DEPLOYMENT }}|g" "$YAML"
          echo "Prepared containerapp.yaml:"
          cat "$YAML"

      - name: Ensure Azure CLI containerapp extension
        run: |
          set -euo pipefail
          az extension add --name containerapp || az extension update --name containerapp

        # keep the APP and RESOURCE_GROUP in sync with containerapp.yaml
      - name: Check if Container App exists
        id: exist
        env:
          RG: ${{ secrets.RESOURCE_GROUP }}
        run: |
          set -euo pipefail
          APP="action-intent-app"
          if az containerapp show -g "$RG" -n "$APP" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      # 已存在：仅更新镜像 —— 这里用 $IMAGE（来自 $GITHUB_ENV），而不是 ${{ env.IMAGE }}
      - name: Update image only (app exists)
        if: steps.exist.outputs.exists == 'true'
        env:
          RG: ${{ secrets.RESOURCE_GROUP }}
        run: |
          set -euo pipefail
          APP="action-intent-app"
          echo "Container App '$APP' exists. Updating image only..."
          az containerapp update \
            -g "$RG" \
            -n "$APP" \
            --image "$IMAGE"
          echo "Image updated to: $IMAGE"

      # 不存在：按 YAML 首次部署
      - name: Deploy Container App using YAML (create if not exists)
        if: steps.exist.outputs.exists == 'false'
        uses: azure/container-apps-deploy-action@v1
        with:
          resourceGroup: ${{ secrets.RESOURCE_GROUP }}
          containerAppName: action-intent-app
          yamlConfigPath: ${{ github.workspace }}/server/containerapp.yaml